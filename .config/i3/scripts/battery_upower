#!/usr/bin/env python3

import subprocess
import re
import os

UP_DEVICE = "/org/freedesktop/UPower/devices/battery_BAT0"
config = dict(os.environ)

def up(cmd):
    return subprocess.check_output(cmd, text=True).strip()

info = up(["upower", "-i", UP_DEVICE])

def get(pattern):
    m = re.search(pattern, info)
    return m.group(1).strip() if m else None

percentage = get(r"percentage:\s+(\d+)%")
state = get(r"state:\s+(\w+)")
time_full  = get(r"time to full:\s+([\d\.]+\s+\w+)")
time_empty = get(r"time to empty:\s+([\d\.]+\s+\w+)")

p = int(percentage) if percentage else 0

# ----- ЧАС -----
if state == "discharging" and time_empty:
    time = f" ({time_empty})"
elif state == "charging" and time_full:
    time = f" ({time_full})"
else:
    time = ""

# ----- ІКОНКИ -----
FA_LIGHTNING = "<span font='FontAwesome'>\uf0e7</span>"
FA_PLUG      = "<span font='FontAwesome'>\uf1e6</span>"
FA_BATTERY   = "<span font='FontAwesome'>\uf240</span>"
FA_QUESTION  = "<span font='FontAwesome'>\uf128</span>"

if state == "discharging":
    icon = FA_BATTERY
elif state == "charging":
    icon = FA_LIGHTNING + " " + FA_PLUG
elif state == "full":
    icon = FA_PLUG
else:
    icon = FA_QUESTION + " " + FA_BATTERY

# ----- КОЛЬОРИ -----
def color(percent):
    if percent < 10:
        return config.get("color_10", "#FFFFFF")
    if percent < 20:
        return config.get("color_20", "#FF3300")
    if percent < 30:
        return config.get("color_30", "#FF6600")
    if percent < 40:
        return config.get("color_40", "#FF9900")
    if percent < 50:
        return config.get("color_50", "#FFCC00")
    if percent < 60:
        return config.get("color_60", "#FFFF00")
    if percent < 70:
        return config.get("color_70", "#FFFF33")
    if percent < 80:
        return config.get("color_80", "#FFFF66")
    return config.get("color_full", "#FFFFFF")

colorized = f"<span color='{color(p)}'>{p}%</span>"

fulltext = f"{icon} {colorized}{time}"

print(fulltext)
print(fulltext)

if p < 10:
    exit(33)

