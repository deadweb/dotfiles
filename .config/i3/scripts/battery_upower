#!/usr/bin/env python3
import subprocess
import re
import os
import time
from pathlib import Path

# --- КОНФІГУРАЦІЯ ---
UP_DEVICE = "/org/freedesktop/UPower/devices/battery_BAT0"
LOG_PATH = Path.home() / ".cache/battery_cutoff.log"
PB_MODE_FLAG = Path("/tmp/powerbank_mode.flag")
PWR_FLAG = Path("/tmp/power_save_active.flag")

def get_upower_data():
    try:
        res = subprocess.check_output(["upower", "-i", UP_DEVICE], text=True)
        now_match = re.search(r"energy:\s+([\d,.]+)", res)
        full_match = re.search(r"energy-full:\s+([\d,.]+)", res)
        st_match = re.search(r"state:\s+(\w+)", res)
        time_match = re.search(r"time to (?:empty|full):\s+([\d,.]+\s+\w+)", res)
        
        e_now = float(now_match.group(1).replace(',', '.')) if now_match else 0.0
        e_full = float(full_match.group(1).replace(',', '.')) if full_match else 1.0
        state = st_match.group(1).strip().lower() if st_match else "unknown"
        time_left = time_match.group(1) if time_match else "невідомо"
        return e_now, e_full, state, time_left
    except:
        return 0.0, 1.0, "unknown", ""

def load_cutoff(e_full):
    if not LOG_PATH.exists() or os.path.getsize(LOG_PATH) == 0:
        return 4.0
    try:
        with open(LOG_PATH, 'r') as f:
            values = [float(l.strip().replace(',', '.')) for l in f if l.strip()]
        avg = sum(values[-5:]) / len(values[-5:])
        return min(avg, 10.0, e_full * 0.15)
    except:
        return 4.0

# Отримуємо дані
energy_now, energy_full, state, time_left = get_upower_data()
cutoff = load_cutoff(energy_full)

# Розрахунок відсотків
p_raw = int((energy_now - cutoff) / (energy_full - cutoff) * 100) if energy_full > cutoff else 0
if state in ("full", "fully-charged") or p_raw >= 95:
    p = 100
elif energy_now <= cutoff:
    p = 0
else:
    p = max(0, min(100, p_raw))

# --- КЕРУВАННЯ КЛІКАМИ ---
btn = os.environ.get("BLOCK_BUTTON")
if btn == "1":
    msg = f"Статус: {state}\nЗалишилось: {time_left}\nЕнергія: {energy_now:.2f} Wh"
    subprocess.run(["notify-send", "-a", "Power", "Статус батареї", msg])
elif btn == "3":
    if state == "discharging":
        subprocess.run(["notify-send", "-u", "critical", "-a", "Power", "Режим", "Неможливо вимкнути економію при розрядці"])
    else:
        if PB_MODE_FLAG.exists():
            PB_MODE_FLAG.unlink()
            subprocess.run(["notify-send", "-a", "Power", "Режим", "Продуктивний режим (AC)"])
        else:
            PB_MODE_FLAG.touch()
            subprocess.run(["notify-send", "-a", "Power", "Режим", "Економія (Powerbank)"])

# --- РОЗУМНА ЕКОНОМІЯ ТА ЗАХИСТ ---
is_eco_active = state == "discharging" or PB_MODE_FLAG.exists()

if is_eco_active:
    if not PWR_FLAG.exists():
        # Максимальне енергозбереження
        subprocess.run(["cpupower", "frequency-set", "-g", "schedutil"], capture_output=True)
        subprocess.run(["cpupower", "set", "-b", "15"], capture_output=True)
        subprocess.run(["rfkill", "block", "bluetooth"], capture_output=True)
        subprocess.run(["iw", "dev", "wlan0", "set", "power_save", "on"], capture_output=True)
        subprocess.run(["brillo", "-S", "65", "-q"])
        PWR_FLAG.touch()
    
    # ПЕРЕВІРКА ПЕРЕД ВИМКНЕННЯМ (тільки при розрядці)
    if state == "discharging":
        # Попередження на 20%
        if 16 <= p <= 20:
            subprocess.run(["notify-send", "-u", "critical", "-a", "Power", "НИЗЬКИЙ ЗАРЯД", f"Залишилось {p}%. Скоро гібернація!"])
        
        # Поріг гібернації 15%
        if p <= 15:
            subprocess.run(["notify-send", "-u", "critical", "-a", "Power", "КРИТИЧНИЙ ЗАРЯД", "15% досягнуто. Гібернація через 5 секунд!"])
            time.sleep(5)
            # Перевірка, чи не підключили зарядку за ці 5 сек
            _, _, current_state, _ = get_upower_data()
            if current_state == "discharging":
                subprocess.run(["systemctl", "hibernate"])
else:
    if PWR_FLAG.exists():
        # Повернення до продуктивності
        subprocess.run(["cpupower", "frequency-set", "-g", "performance"], capture_output=True)
        subprocess.run(["cpupower", "set", "-b", "0"], capture_output=True)
        subprocess.run(["rfkill", "unblock", "bluetooth"], capture_output=True)
        subprocess.run(["iw", "dev", "wlan0", "set", "power_save", "off"], capture_output=True)
        subprocess.run(["brillo", "-S", "85", "-q"])
        PWR_FLAG.unlink(missing_ok=True)

# --- ВИВІД ДЛЯ ПАНЕЛІ ---
if state == "charging":
    icon = "\uf1e6"
elif state in ("full", "fully-charged") or (p == 100 and state != "discharging"):
    icon = "\uf1e6"
else:
    icon = "\uf240"

# Колір: Ціан (економія), Червоний (критично), Білий (норма)
if is_eco_active:
    main_color = "#00FFFF"
elif p <= 15:
    main_color = "#FF3300"
else:
    main_color = "#FFFFFF"

fulltext = f"<span color='{main_color}' font='FontAwesome'>{icon} {p}%</span>"

print(fulltext)
print(fulltext)
